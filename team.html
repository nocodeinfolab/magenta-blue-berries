<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HR Connect | Team Management</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&disprow.style.cursor = 'default';lay=swap" rel="stylesheet">
    <link rel="stylesheet" href="team.css">
    
    <style>
        /* Additional styles for the new tab */
        .status-group {
            margin-bottom: 30px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        }
        
        .status-group-header {
            padding: 16px 20px;
            background: var(--background-light);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .status-group-title {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-group-count {
            background: var(--gray);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-group.approved .status-group-header {
            background: rgba(76, 175, 80, 0.1);
            border-left: 4px solid #4CAF50;
        }
        
        .status-group.pending .status-group-header {
            background: rgba(255, 152, 0, 0.1);
            border-left: 4px solid #FF9800;
        }
        
        .staff-table-container {
            margin-top: 20px;
        }
        
        .access-denied-message {
            text-align: center;
            padding: 60px 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            margin-top: 20px;
        }
        
        .access-denied-message .denied-icon {
            font-size: 48px;
            color: #ff9800;
            margin-bottom: 20px;
        }
        .leave-row {
            cursor: pointer;
            transition: background-color 0.2s ease;
        }
        
        .leave-row:hover {
            background-color: rgba(0, 0, 0, 0.02);
        }
        .status-group.rejected .status-group-header {
            background: rgba(244, 67, 54, 0.1);
            border-left: 4px solid #F44336;
        }

    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <p style="color: var(--gray); margin-top: 10px;">Loading team data...</p>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <aside class="sidebar">
            <div class="logo">
                <i class="fas fa-users"></i>
                <h1>HR Connect</h1>
            </div>
            
            <ul class="nav-links">
                <li><a href="#" class="active" data-tab="team"><i class="fas fa-user-friends"></i> <span>Team Management</span></a></li>
                <li><a href="#" data-tab="leaves"><i class="fas fa-calendar-alt"></i> <span>Team Leaves</span></a></li>
                <!-- New Tab - Will be shown/hidden based on role -->
                <li id="allStaffLeavesTab" style="display: none;">
                    <a href="#" data-tab="all-staff-leaves">
                        <i class="fas fa-calendar-check"></i> 
                        <span>All Staff Leaves</span>
                    </a>
                </li>
                <li><a href="#" data-tab="reports"><i class="fas fa-chart-bar"></i> <span>Reports</span></a></li>
                <li><a href="#" data-tab="approvals"><i class="fas fa-check-circle"></i> <span>Approvals</span></a></li>
                <li><a href="#" data-tab="settings"><i class="fas fa-cog"></i> <span>Settings</span></a></li>
            </ul>
            
            <div class="user-profile">
                <div class="user-info">
                    <div class="user-avatar" id="sidebarAvatar">--</div>
                    <div class="user-details">
                        <h4 id="sidebarUserName">Loading...</h4>
                        <p>Manager</p>
                    </div>
                </div>
                <button
                    id="logoutBtn"
                    class="btn"
                    style="
                        width: 100%;
                        margin-top: 12px;
                        background: rgba(231, 76, 60, 0.15);
                        color: #e74c3c;
                        justify-content: center;
                        padding: 12px 16px;
                        border-radius: 6px;
                        font-weight: 500;
                        border: 1px solid rgba(231, 76, 60, 0.3);
                        display: flex;
                        align-items: center;
                        gap: 8px;
                    "
                >
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </button>
            </div>
        </aside>
        
        <!-- Main Content -->
        <main class="main-content">
            <!-- Header -->
            <div class="header">
                <div class="header-left">
                    <!-- Back button on the left -->
                    <button 
                        id="backToDashboardBtn" 
                        class="back-btn"
                        style="
                            margin-right: 16px;
                            background: #f8f9fa;
                            border: 1px solid #dee2e6;
                            border-radius: 6px;
                            padding: 8px 12px;
                            display: inline-flex;
                            align-items: center;
                            gap: 8px;
                            cursor: pointer;
                            color: #495057;
                            font-weight: 500;
                            transition: all 0.2s ease;
                        "
                    >
                        <i class="fas fa-arrow-left"></i>
                        <span>Dashboard</span>
                    </button>
                    
                    <div>
                        <h2 id="pageTitle">Team Management</h2>
                        <p id="pageSubtitle">Manage your team members and view their details</p>
                    </div>
                </div>
            </div>

            <!-- Error Message -->
            <div class="error-message hidden" id="errorMessage"></div>

            <!-- Stats Cards -->
            <div class="header-stats">
                <div class="stat-card">
                    <div class="stat-icon team">
                        <i class="fas fa-users"></i>
                    </div>
                    <div class="stat-content">
                        <h3 id="teamCount">0</h3>
                        <p>Team Members</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon manager">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-content">
                        <h3>1</h3>
                        <p>Manager</p>
                    </div>
                </div>
            </div>

            <!-- Manager Profile Section -->
            <h3 class="section-title">Your Profile</h3>
            <div class="manager-card" id="managerCard">
                <div class="manager-header">
                    <div class="manager-avatar" id="managerAvatar">--</div>
                    <div class="manager-info">
                        <h3 id="managerName">Loading...</h3>
                        <p id="managerTitle">Loading...</p>
                        <span class="manager-badge">
                            <i class="fas fa-crown"></i> Team Manager
                        </span>
                    </div>
                </div>
                <div class="manager-details">
                    <div class="detail-item">
                        <strong>Department</strong>
                        <span id="managerDepartment">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <strong>Job Category</strong>
                        <span id="managerJobCategory">Loading...</span>
                    </div>
                    <div class="detail-item">
                        <strong>Employee ID</strong>
                        <span id="managerEmployeeId">Loading...</span>
                    </div>
                </div>
            </div>

            <!-- Team Members Section -->
            <h3 class="section-title">Team Members</h3>
            
            <!-- Empty State -->
            <div class="empty-table-state" id="emptyState">
                <div class="empty-icon">
                    <i class="fas fa-user-friends"></i>
                </div>
                <h3>No Team Members Found</h3>
                <p>There are no team members assigned to you yet. Team members will appear here when they're added to your team.</p>
            </div>
            
            <!-- Team Members Table -->
            <div class="team-table-container hidden" id="teamTableContainer">
                <div class="table-responsive">
                    <table class="team-table" id="teamTable">
                        <thead>
                            <tr>
                                <th>Team Member</th>
                                <th>Employee ID</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody id="teamTableBody">
                            <!-- Team members will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
    /* =========================================================
       GLOBAL CONFIG
    ========================================================= */
    const API_BASE = "https://asiukpohr.nocodeinfolab.workers.dev";
    let cachedTeamData = null;
    let originalTeamViewHTML = null;
    let userJobTitle = "";
    let originalTeamLeavesViewHTML = null;


    
    /* =========================================================
       DOM ELEMENTS
    ========================================================= */
    const loadingOverlay = document.getElementById("loadingOverlay");
    const errorMessage = document.getElementById("errorMessage");
    const allStaffLeavesTab = document.getElementById("allStaffLeavesTab");
    
    const pageTitle = document.getElementById("pageTitle");
    const pageSubtitle = document.getElementById("pageSubtitle");
    const teamCount = document.getElementById("teamCount");
    
    const managerCard = document.getElementById("managerCard");
    const managerAvatar = document.getElementById("managerAvatar");
    const managerName = document.getElementById("managerName");
    const managerTitle = document.getElementById("managerTitle");
    const managerDepartment = document.getElementById("managerDepartment");
    const managerJobCategory = document.getElementById("managerJobCategory");
    const managerEmployeeId = document.getElementById("managerEmployeeId");
    
    const teamTableContainer = document.getElementById("teamTableContainer");
    const teamTableBody = document.getElementById("teamTableBody");
    const emptyState = document.getElementById("emptyState");
    
    const sidebarAvatar = document.getElementById("sidebarAvatar");
    const sidebarUserName = document.getElementById("sidebarUserName");
    
    /* =========================================================
       UTILITY FUNCTIONS
    ========================================================= */
    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.classList.remove("hidden");
        setTimeout(() => errorMessage.classList.add("hidden"), 5000);
    }
    function isHRManager(jobTitle) {
        if (!jobTitle) return false;
        return jobTitle.trim() === "Human Resource Manager";
    }
    
    function isCEO(jobTitle) {
        if (!jobTitle) return false;
        return jobTitle.trim() === "Chief Executive Officer";
    }
    
    function getInitials(name) {
        if (!name || name === "Loading...") return "--";
        const parts = name.trim().split(" ");
        if (parts.length >= 2) {
            return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
        }
        return name.substring(0, 2).toUpperCase();
    }
    
    function formatName(name) {
        if (!name) return "N/A";
        return name;
    }
    
    // Check if user has permission for All Staff Leaves tab
    function hasAllStaffLeavesPermission(jobTitle) {
        if (!jobTitle) return false;
        
        const exactTitle = jobTitle.trim();
        const hasPermission = exactTitle === "Chief Executive Officer" || 
                              exactTitle === "Human Resource Manager";
        
        console.log("üîç Permission Check - Title:", `"${exactTitle}"`, 
                    "| Has permission:", hasPermission);
        
        return hasPermission;
    }
    /* =========================================================
       BACK TO DASHBOARD
    ========================================================= */
    const backToDashboardBtn = document.getElementById('backToDashboardBtn');
    
    if (backToDashboardBtn) {
        backToDashboardBtn.addEventListener('click', () => {
            window.location.href = '/dashboard.html';
        });
    }
    
    /* =========================================================
       FETCH TEAM DATA
    ========================================================= */
    async function fetchTeamData() {
        try {
            const response = await fetch(`${API_BASE}/manage-team`, {
                method: "GET",
                credentials: "include",
                headers: { "Content-Type": "application/json" }
            });
    
            const data = await response.json();
            
            if (!response.ok || !data.success) {
                console.log("BACKEND DEBUG RAW RESPONSE:", data);
                console.log("BACKEND DEBUG DETAILS:", data.debug);
            
                throw new Error(data.message || "Failed to load team data");
            }
    
            return data;
        } catch (err) {
            console.error("Error fetching team data:", err);
            showError("Failed to load team data. Please try again.");
            return null;
        }
    }
    
    /* =========================================================
       POPULATE MANAGER PROFILE
    ========================================================= */
    function populateManagerProfile(manager) {
        const initials = getInitials(manager.fullName);
        
        // Store job title for permission checks
        userJobTitle = manager.jobTitle || "";
        
        // Show/hide All Staff Leaves tab based on role
        if (hasAllStaffLeavesPermission(userJobTitle)) {
            allStaffLeavesTab.style.display = "block";
        } else {
            allStaffLeavesTab.style.display = "none";
        }
        
        // Update sidebar
        sidebarAvatar.textContent = initials;
        sidebarUserName.textContent = manager.fullName;
        
        // Update manager card
        managerAvatar.textContent = initials;
        managerName.textContent = formatName(manager.fullName);
        managerTitle.textContent = manager.jobTitle || "Manager";
        managerDepartment.textContent = manager.department || "N/A";
        managerJobCategory.textContent = manager.jobCategory || "N/A";
        managerEmployeeId.textContent = manager.employeeId || "N/A";
        
        // Update page title with manager name
        pageTitle.textContent = `${manager.fullName}'s Team`;
        pageSubtitle.textContent = `Managing ${manager.department || "the"} department`;
    }
    
    /* =========================================================
       POPULATE TEAM MEMBERS TABLE
    ========================================================= */
    function populateTeamMembers(teamMembers) {
        teamCount.textContent = teamMembers.length;
        
        // Show/hide empty state and table
        if (teamMembers.length > 0) {
            emptyState.classList.add("hidden");
            teamTableContainer.classList.remove("hidden");
            
            // Clear existing table rows
            teamTableBody.innerHTML = '';
            
            // Create table rows
            teamMembers.forEach(member => {
                
                const row = document.createElement('tr');
            
                const initials = getInitials(member.fullName);
                const memberId = member.employeeId || 'N/A';
                const jobTitle = member.jobTitle || 'Employee';
            
                const isOnLeave = Number(member.leaveStatus) === 1;
            
                const statusText = isOnLeave ? 'On Leave' : 'Active';
                const statusClass = isOnLeave ? 'status-inactive' : 'status-active';
                const statusIcon = isOnLeave ? 'fas fa-clock' : 'fas fa-circle-check';
            
                row.innerHTML = `
                    <td>
                        <div class="member-cell">
                            <div class="table-avatar">${initials}</div>
                            <div class="member-info">
                                <span class="member-name">${formatName(member.fullName)}</span>
                                <span class="member-title">${jobTitle}</span>
                            </div>
                        </div>
                    </td>
                    <td>
                        <span class="employee-id">${memberId}</span>
                    </td>
                    <td>
                        <span class="status-badge ${statusClass}">
                            <i class="${statusIcon}"></i>
                            ${statusText}
                        </span>
                    </td>
                    
                `;
            
                teamTableBody.appendChild(row);
            });

        } else {
            emptyState.classList.remove("hidden");
            teamTableContainer.classList.add("hidden");
        }
    }

    function renderAllStaffLeaves(allLeaves) {

        // 1Ô∏è‚É£ Permission check
        if (!hasAllStaffLeavesPermission(userJobTitle)) {
            pageTitle.textContent = "Access Denied";
            pageSubtitle.textContent = "You don't have permission to view this page";
    
            document.querySelector(".main-content").innerHTML = `
                <div class="access-denied-message">
                    <div class="denied-icon">
                        <i class="fas fa-lock"></i>
                    </div>
                    <h3>Access Restricted</h3>
                    <p>The "All Staff Leaves" tab is only available for Chief Executive Officer and Human Resources Manager roles.</p>
                    <p>Your current role: <strong>${userJobTitle || "Not specified"}</strong></p>
                    <button class="table-action-btn" onclick="switchToTab('team')" style="margin-top: 20px;">
                        <i class="fas fa-arrow-left"></i>
                        Return to Team Management
                    </button>
                </div>
            `;
            return;
        }
    
        // 2Ô∏è‚É£ Role flags
        const isHr = isHRManager(userJobTitle);
        const isCeo = isCEO(userJobTitle);
    
        // 3Ô∏è‚É£ Dynamic subtitles
        const pendingSubtitle = isCeo
            ? "Leaves approved by HR awaiting final approval"
            : "Leaves approved by HOD awaiting HR approval";
    
        const approvedSubtitle = isCeo
            ? "Leaves fully approved by HR and CEO"
            : "Leaves approved by HOD and HR";
    
        // 4Ô∏è‚É£ Filter visible leaves
        let visibleLeaves = allLeaves.filter(leave =>
            leave.hodApproval === true || leave.hodApproval === "true"
        );
    
        if (isCeo) {
            visibleLeaves = visibleLeaves.filter(leave =>
                leave.hrApproval === true || leave.hrApproval === "true"
            );
        }
        // Step 3: Exclude rejected leaves from pending/approved
        const nonRejectedLeaves = visibleLeaves.filter(leave =>
            (leave.status || '').toLowerCase() !== 'rejected'
        );

    
        // 5Ô∏è‚É£ Split leaves
        let pendingLeaves = [];
        let approvedLeaves = [];
        
        if (isHr) {
            // HR: waiting for HR approval
            pendingLeaves = nonRejectedLeaves.filter(leave =>
                (leave.hodApproval === true || leave.hodApproval === "true") &&
                !(leave.hrApproval === true || leave.hrApproval === "true")
            );
        
            // HR-approved leaves
            approvedLeaves = nonRejectedLeaves.filter(leave =>
                leave.hrApproval === true || leave.hrApproval === "true"
            );
        }
        
        if (isCeo) {
            // CEO: waiting for CEO approval
            pendingLeaves = nonRejectedLeaves.filter(leave =>
                (leave.hrApproval === true || leave.hrApproval === "true") &&
                !(leave.ceoApproval === true || leave.ceoApproval === "true")
            );
        
            // Fully approved leaves
            approvedLeaves = nonRejectedLeaves.filter(leave =>
                leave.ceoApproval === true || leave.ceoApproval === "true"
            );
        }

        // 5Ô∏è‚É£b Rejected leaves (visible to BOTH HR and CEO)
        const rejectedLeaves = visibleLeaves.filter(leave =>
            (leave.status || '').toLowerCase() === 'rejected'
        );


    
        // 6Ô∏è‚É£ Header
        pageTitle.textContent = "All Staff Leaves";
        pageSubtitle.textContent = isCeo
            ? "Leaves approved by HR awaiting final approval"
            : "View and manage all staff leave requests";
    
        // 7Ô∏è‚É£ Render HTML
        document.querySelector(".main-content").innerHTML = `
            <div class="header">
                <div class="header-left">
                    <h2 id="pageTitle">All Staff Leaves</h2>
                    <p id="pageSubtitle"></p>
                </div>
            </div>
    
            <div class="staff-table-container">
    
                <div class="status-group pending">
                    <div class="status-group-header">
                        <div class="status-group-title">
                            <i class="fas fa-clock" style="color:#FF9800;"></i>
                            <h3>Pending Approval</h3>
                            <span class="status-group-count">${pendingLeaves.length}</span>
                        </div>
                        <div class="status-subtitle">${pendingSubtitle}</div>
                    </div>
                    ${renderLeavesTable(pendingLeaves, 'pending')}
                </div>
    
                <div class="status-group approved">
                    <div class="status-group-header">
                        <div class="status-group-title">
                            <i class="fas fa-check-circle" style="color:#4CAF50;"></i>
                            <h3>Approved Leaves</h3>
                            <span class="status-group-count">${approvedLeaves.length}</span>
                        </div>
                        <div class="status-subtitle">${approvedSubtitle}</div>
                    </div>
                    ${renderLeavesTable(approvedLeaves, 'approved')}
                </div>
                <div class="status-group rejected">
                    <div class="status-group-header">
                        <div class="status-group-title">
                            <i class="fas fa-times-circle" style="color:#F44336;"></i>
                            <h3>Rejected Leaves</h3>
                            <span class="status-group-count">${rejectedLeaves.length}</span>
                        </div>
                        <div class="status-subtitle">
                            Leaves that were reviewed and rejected
                        </div>
                    </div>
                    ${renderLeavesTable(rejectedLeaves, 'rejected')}
                </div>
    
                ${visibleLeaves.length === 0 ? `
                    <div class="empty-table-state">
                        <h3>No Leave Records Found</h3>
                        <p>
                            ${isCeo
                                ? 'There are no leave requests approved by HR yet.'
                                : 'There are no leave records that have been approved by HODs yet.'
                            }
                        </p>
                    </div>
                ` : ''}
    
            </div>
        `;
    
        setTimeout(() => {
            document.querySelectorAll('.leave-row').forEach(row => {
                row.addEventListener('click', function () {
                    showAllStaffLeaveModal(
                        JSON.parse(this.dataset.leaveData),
                        JSON.parse(this.dataset.memberData)
                    );
                });
            });
        }, 100);
    }

    
    function renderLeavesTable(leaves, statusType) {
        if (leaves.length === 0) {
            return `
                <div class="empty-table-state" style="margin: 20px; padding: 40px;">
                    <div class="empty-icon">
                        <i class="fas fa-inbox"></i>
                    </div>
                    <h4>
                        No ${
                            statusType === 'approved'
                                ? 'Approved'
                                : statusType === 'rejected'
                                ? 'Rejected'
                                : 'Pending'
                        } Leaves
                    </h4>

                    <p>
                        There are no ${
                            statusType === 'approved'
                                ? 'approved'
                                : statusType === 'rejected'
                                ? 'rejected'
                                : 'pending'
                        } leave requests at the moment.
                    </p>

                </div>
            `;
        }
        
        return `
            <div class="table-responsive">
                <table class="team-table">
                    <thead>
                        <tr>
                            <th>Staff Member</th>
                            <th>Employee ID</th>
                            <th>Department</th>
                            <th>Leave Type</th>
                            <th>Period</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${leaves.map((leave, index) => {
                            // Find member info from cached team data
                            let member = null;
                            if (cachedTeamData && cachedTeamData.team) {
                                member = cachedTeamData.team.find(m => 
                                    m.employeeId === leave.employeeId
                                );
                            }
                            
                            // Fallback if member not found in team
                            if (!member) {
                                member = {
                                    fullName: leave.employeeName || "Unknown",
                                    jobTitle: leave.jobTitle || "N/A",
                                    department: leave.department || "N/A"
                                };
                            }
                            
                            const initials = getInitials(member.fullName);
                            
                            return `
                                <tr class="leave-row" 
                                    data-index="${index}"
                                    data-leave-data='${JSON.stringify(leave).replace(/'/g, "&apos;")}'
                                    data-member-data='${JSON.stringify(member).replace(/'/g, "&apos;")}'>
                                    <td>
                                        <div class="member-cell">
                                            <div class="table-avatar">${initials}</div>
                                            <div class="member-info">
                                                <span class="member-name">${member.fullName}</span>
                                                <span class="member-title">${member.jobTitle || "Employee"}</span>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="employee-id">${leave.employeeId}</span>
                                    </td>
                                    <td>
                                        <span class="department">${member.department || "N/A"}</span>
                                    </td>
                                    <td>
                                        <span class="leave-type-badge ${(leave.leaveType || '').toLowerCase().replace(/\s+/g, '-')}">
                                            ${leave.leaveType || "N/A"}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="leave-period">
                                            <span class="leave-date start">${leave.startDate}</span>
                                            <span class="leave-separator">to</span>
                                            <span class="leave-date end">${leave.endDate}</span>
                                        </div>
                                    </td>
                                </tr>
                            `;
                        }).join("")}
                    </tbody>
                </table>
            </div>
        `;
    }
    
    function showAllStaffLeaveModal(leave, member) {
        // Remove existing modal if any
        const existingModal = document.getElementById('allStaffLeaveModal');
        if (existingModal) {
            existingModal.remove();
        }
    
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'allStaffLeaveModal';
        modal.className = 'modal-overlay';
        
        // Check if current user can approve (HR Manager or CEO)
        const canApprove = hasAllStaffLeavesPermission(userJobTitle) && 
                          (leave.status || '').toLowerCase() === 'pending';
        const isHr = isHRManager(userJobTitle);
        const isCeo = isCEO(userJobTitle);

        
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Leave Details</h3>
                    <button class="modal-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <!-- Staff Information -->
                    <div class="modal-section">
                        <h4>Staff Information</h4>
                        <div class="staff-info">
                            <div class="staff-avatar">${getInitials(member.fullName)}</div>
                            <div class="staff-details">
                                <h5>${member.fullName}</h5>
                                <p>${member.jobTitle || 'Employee'}</p>
                                <p class="employee-id-modal">${leave.employeeId}</p>
                                <p class="department-modal">${member.department || 'N/A'}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Leave Details -->
                    <div class="modal-section">
                        <h4>Leave Details</h4>
                        <div class="leave-details-grid">
                            <div class="detail-item">
                                <strong>Leave Type</strong>
                                <span>${leave.leaveType || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Period</strong>
                                <span>${leave.startDate} to ${leave.endDate}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Days</strong>
                                <span>${leave.leaveDays || leave.daysRequested || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Status</strong>
                                <span class="status-badge ${leave.status === 'Approved' ? 'status-active' : leave.status === 'Rejected' ? 'status-inactive' : 'status-pending'}">
                                    ${leave.status || 'Pending'}
                                </span>
                            </div>
                        </div>
                        ${leave.reason ? `
                        <div class="detail-item full-width">
                            <strong>Reason</strong>
                            <p class="leave-reason">${leave.reason}</p>
                        </div>
                        ` : ''}
                    </div>
                    
                    <!-- Approval Status -->
                    <div class="modal-section">
                        <h4>Approval Status</h4>
                        <div class="approval-status-grid">
                            <div class="approval-status approved">
                                <i class="fas fa-check-circle"></i>
                                <span>HOD Approved</span>
                            </div>
                            <div class="approval-status ${leave.hrApproval ? 'approved' : 'pending'}">
                                <i class="fas ${leave.hrApproval ? 'fa-check-circle' : 'fa-clock'}"></i>
                                <span>HR ${leave.hrApproval ? 'Approved' : 'Pending'}</span>
                            </div>
                            <div class="approval-status ${leave.ceoApproval ? 'approved' : 'pending'}">
                                <i class="fas ${leave.ceoApproval ? 'fa-check-circle' : 'fa-clock'}"></i>
                                <span>CEO ${leave.ceoApproval ? 'Approved' : 'Pending'}</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Approval Action (only if pending and user has permission) -->
                    ${canApprove ? `
                    <div class="modal-section">
                        <h4>${isHr ? 'HR' : 'CEO'} Action</h4>
                        <div class="approval-action-section">
                            <p class="approval-note">
                                ${
                                    isHr
                                        ? "This leave has been approved by HOD. You can now provide HR approval."
                                        : "This leave has been approved by HR. You can now provide final CEO approval."
                                }
                            </p>

                            <div class="approval-actions">
                                <button class="approve-btn final-approve">
                                    <i class="fas fa-thumbs-up"></i>
                                    ${isHr ? 'HR Approve' : 'CEO Approve'}
                                </button>

                                <button class="reject-btn final-reject" data-leave-id="${leave.id || leave.employeeId}">
                                    <i class="fas fa-thumbs-down"></i>
                                    Reject
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : leave.status === 'Approved' ? `
                    <div class="modal-section">
                        <div class="already-approved">
                            <i class="fas fa-check-circle"></i>
                            <p>This leave has already been fully approved.</p>
                        </div>
                    </div>
                    ` : ''}
                </div>
            </div>
        `;
    
        document.body.appendChild(modal);
    
        // Add event listeners
        modal.querySelector('.modal-close-btn').addEventListener('click', () => {
            modal.remove();
        });
    
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    
        // Add approval button listeners
        if (canApprove) {
            modal.querySelector('.final-approve').addEventListener('click', function() {
                const leaveId = this.getAttribute('data-leave-id');
                approveFinalLeave(leaveId, true, userJobTitle.includes('HR') ? 'hr' : 'ceo');
            });
    
            modal.querySelector('.final-reject').addEventListener('click', function() {
                const leaveId = this.getAttribute('data-leave-id');
                approveFinalLeave(leaveId, false, userJobTitle.includes('HR') ? 'hr' : 'ceo');
            });
        }
    }
    
    async function approveFinalLeave(leaveId, approve, approvalType) {
        try {
            const modal = document.getElementById('allStaffLeaveModal');
            const actionSection = modal.querySelector('.approval-action-section');
            const originalHTML = actionSection.innerHTML;
            
            actionSection.innerHTML = `
                <div class="loading-approval">
                    <div class="spinner-small"></div>
                    <p>${approve ? 'Approving' : 'Rejecting'} leave request...</p>
                </div>
            `;
    
            // Call backend API
            const response = await fetch(`${API_BASE}/approve-leave`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    leaveId: leaveId,
                    action: approve ? 'approve' : 'reject',
                    approvalType: approvalType // 'hr' or 'ceo'
                })
            });
    
            const data = await response.json();
    
            if (data.success) {
                actionSection.innerHTML = `
                    <div class="approval-success">
                        <i class="fas fa-check-circle"></i>
                        <p>Leave ${approve ? 'approved' : 'rejected'} successfully!</p>
                        <button class="modal-close-btn secondary" onclick="closeModalAndRefreshAllStaff()">
                            Close & Refresh
                        </button>
                    </div>
                `;
            } else {
                actionSection.innerHTML = `
                    <div class="approval-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to process approval: ${data.message || 'Unknown error'}</p>
                        <button class="modal-close-btn secondary" onclick="location.reload()">
                            Retry
                        </button>
                    </div>
                `;
            }
    
        } catch (error) {
            console.error('Approval error:', error);
            const modal = document.getElementById('allStaffLeaveModal');
            const actionSection = modal.querySelector('.approval-action-section');
            
            actionSection.innerHTML = `
                <div class="approval-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Network error: ${error.message}</p>
                    <button class="modal-close-btn secondary" onclick="location.reload()">
                        Retry
                    </button>
                </div>
            `;
        }
    }
    
    function closeModalAndRefreshAllStaff() {
        const modal = document.getElementById('allStaffLeaveModal');
        if (modal) modal.remove();
        
        // Refresh all staff leaves view
        if (cachedTeamData) {
            renderAllStaffLeaves(cachedTeamData.leaves || []);
        }
    }

    // Original renderTeamLeaves function (unchanged)
    function renderTeamLeaves(team, leaves) {
        // Build quick lookup for team members by employee ID
        const teamMap = {};
        team.forEach(m => {
            if (m.employeeId) {
                teamMap[m.employeeId] = m;
            }
        });
    
        // Filter leave rows belonging to team members
        let teamLeaves = leaves.filter(l => teamMap[l.employeeId]);
    
        // Update header
        pageTitle.textContent = "Team Leaves";
        pageSubtitle.textContent = "Leave records for your team members";
    
        // Remove existing team view sections
        document.querySelectorAll(
            ".manager-card, .section-title, .team-table-container, .empty-table-state"
        ).forEach(el => el.remove());
    
        // Create filter section
        const filterSection = document.createElement('div');
        filterSection.className = 'filter-section';
        
        // Create unique staff list for dropdown
        const staffList = [];
        const staffMap = {};
        
        team.forEach(member => {
            if (member.employeeId && !staffMap[member.employeeId]) {
                staffList.push({
                    employeeId: member.employeeId,
                    fullName: member.fullName,
                    jobTitle: member.jobTitle
                });
                staffMap[member.employeeId] = true;
            }
        });
        
        // Sort staff alphabetically by name
        staffList.sort((a, b) => a.fullName.localeCompare(b.fullName));
    
        filterSection.innerHTML = `
            <div class="filter-container">
                <div class="filter-header">
                    <h4>Filter Leaves</h4>
                    <span class="filter-count" id="filterCount">Showing ${teamLeaves.length} records</span>
                </div>
                
                <!-- Leave Balance Display -->
                <div class="leave-balance-card" id="leaveBalanceCard">
                    <div class="leave-balance-header">
                        <i class="fas fa-calendar-check"></i>
                        <h5>Annual Leave Balance</h5>
                    </div>
                    <div class="leave-balance-stats" id="leaveBalanceStats">
                        <div class="balance-stat">
                            <span class="balance-label">Total Allowed</span>
                            <span class="balance-value total-allowed">24</span>
                        </div>
                        <div class="balance-stat">
                            <span class="balance-label">Used</span>
                            <span class="balance-value used-days" id="usedDays">0</span>
                        </div>
                        <div class="balance-stat">
                            <span class="balance-label">Remaining</span>
                            <span class="balance-value remaining-days" id="remainingDays">24</span>
                        </div>
                    </div>
                    <div class="balance-note" id="balanceNote">
                        Showing balance for all staff
                    </div>
                </div>
                
                <div class="filter-controls">
                    <div class="filter-group">
                        <label for="staffFilter">Staff Member</label>
                        <select id="staffFilter" class="filter-select">
                            <option value="all">All Team Members</option>
                            ${staffList.map(staff => `
                                <option value="${staff.employeeId}">
                                    ${staff.fullName} (${staff.jobTitle || 'Employee'})
                                </option>
                            `).join('')}
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label for="statusFilter">Status</label>
                        <select id="statusFilter" class="filter-select">
                            <option value="all">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="approved">Approved</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    
                    <div class="filter-actions">
                        <button class="filter-clear-btn" id="clearFilters">
                            <i class="fas fa-times"></i>
                            Clear Filters
                        </button>
                    </div>
                </div>
            </div>
        `;
    
        document.querySelector(".main-content").appendChild(filterSection);
    
        // Store original leaves for filtering
        let allLeaves = [...teamLeaves];
        let currentStaffFilter = 'all';
        let currentStatusFilter = 'all';
    
        // Function to calculate leave balance for a specific staff member
        function calculateLeaveBalance(staffEmployeeId, leavesToCheck) {
            const ANNUAL_LEAVE_DAYS = 24;
            
            // Filter approved annual leaves for the staff member
            const approvedAnnualLeaves = leavesToCheck.filter(leave => {
                return leave.employeeId === staffEmployeeId &&
                       (leave.status || '').toLowerCase() === 'approved' &&
                       (leave.leaveType || '').toLowerCase() === 'annual';
            });
            
            // Calculate total used days
            const totalUsedDays = approvedAnnualLeaves.reduce((total, leave) => {
                return total + (Number(leave.leaveDays) || Number(leave.daysRequested) || 0);
            }, 0);
            
            const remainingDays = ANNUAL_LEAVE_DAYS - totalUsedDays;
            
            return {
                used: totalUsedDays,
                remaining: remainingDays > 0 ? remainingDays : 0,
                exceeded: remainingDays < 0
            };
        }
    
        // Function to update leave balance display
        function updateLeaveBalanceDisplay(staffEmployeeId, leavesToCheck) {
            const balanceCard = document.getElementById('leaveBalanceCard');
            const balanceNote = document.getElementById('balanceNote');
            
            if (staffEmployeeId === 'all') {
                // Show overall balance message
                balanceNote.textContent = 'Showing balance for all staff';
                
                // Calculate average or show N/A
                document.getElementById('usedDays').textContent = '';
                document.getElementById('remainingDays').textContent = '';
                
                balanceCard.classList.remove('staff-specific');
            } else {
                // Calculate and display specific staff balance
                const staffMember = team.find(m => m.employeeId === staffEmployeeId);
                const balance = calculateLeaveBalance(staffEmployeeId, leavesToCheck);
                
                document.getElementById('usedDays').textContent = balance.used;
                document.getElementById('remainingDays').textContent = balance.remaining;
                
                // Update note with staff name
                balanceNote.textContent = `Balance for ${staffMember?.fullName || 'Selected Staff'}`;
                
                // Highlight if exceeded
                if (balance.exceeded) {
                    document.getElementById('remainingDays').classList.add('exceeded');
                } else {
                    document.getElementById('remainingDays').classList.remove('exceeded');
                }
                
                balanceCard.classList.add('staff-specific');
            }
        }
    
        // Function to filter and render table
        function filterAndRenderTable() {
            let filteredLeaves = allLeaves;
            
            // Apply staff filter
            if (currentStaffFilter !== 'all') {
                filteredLeaves = filteredLeaves.filter(leave => 
                    leave.employeeId === currentStaffFilter
                );
            }
            
            // Apply status filter
            if (currentStatusFilter !== 'all') {
                filteredLeaves = filteredLeaves.filter(leave => {
                    const status = (leave.status || '').toLowerCase();
                    return status === currentStatusFilter;
                });
            }
            // ‚úÖ SORT LEAVES: Pending first, then Approved, then Rejected
            filteredLeaves.sort((a, b) => {
                const statusA = (a.status || '').toLowerCase();
                const statusB = (b.status || '').toLowerCase();
                
                // Define sorting order
                const order = { 'pending': 1, 'approved': 2, 'rejected': 3 };
                
                // Get order values (default to 99 if status not in order)
                const orderA = order[statusA] || 99;
                const orderB = order[statusB] || 99;
                
                // Primary sort by status
                if (orderA !== orderB) {
                    return orderA - orderB;
                }
                
                // Secondary sort by start date (most recent first)
                const dateA = new Date(a.startDate || 0);
                const dateB = new Date(b.startDate || 0);
                return dateB - dateA;
            });
            
            teamLeaves = filteredLeaves;
            
            // Update filter count
            document.getElementById('filterCount').textContent = `Showing ${filteredLeaves.length} records`;
            
            // Update leave balance display
            updateLeaveBalanceDisplay(currentStaffFilter, allLeaves);
            
            // Remove existing table if it exists
            const existingTable = document.querySelector('.team-table-container');
            if (existingTable) {
                existingTable.remove();
            }
            
            // Remove empty state if it exists
            const existingEmptyState = document.querySelector('.empty-table-state');
            if (existingEmptyState) {
                existingEmptyState.remove();
            }
    
            // Show empty state if no records after filtering
            if (!filteredLeaves.length) {
                const empty = document.createElement("div");
                empty.className = "empty-table-state";
                empty.innerHTML = `
                    <div class="empty-icon">
                        <i class="fas fa-calendar-times"></i>
                    </div>
                    <h3>No Leave Records Found</h3>
                    <p>No leave records match your filter criteria. Try changing your filter settings.</p>
                    <button class="table-action-btn" id="clearFilterBtn" style="margin-top: 16px;">
                        <i class="fas fa-filter"></i>
                        Clear Filters
                    </button>
                `;
                document.querySelector(".main-content").appendChild(empty);
                
                // Add event listener to clear filter button
                setTimeout(() => {
                    document.getElementById('clearFilterBtn').addEventListener('click', () => {
                        document.getElementById('staffFilter').value = 'all';
                        document.getElementById('statusFilter').value = 'all';
                        currentStaffFilter = 'all';
                        currentStatusFilter = 'all';
                        filterAndRenderTable();
                    });
                }, 100);
                
                return;
            }
    
            // Build table container
            const container = document.createElement("div");
            container.className = "team-table-container";
    
            container.innerHTML = `
                <div class="table-responsive">
                    <table class="team-table">
                        <thead>
                            <tr>
                                <th>Staff</th>
                                <th>Employee ID</th>
                                <th>Leave Type</th>
                                <th>Period</th>
                                <th>Days</th>
                                <th>Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredLeaves.map((leave, index) => {
                                const member = teamMap[leave.employeeId];
                                const initials = getInitials(member.fullName);
    
                                const statusText = leave.status || "Pending";
                                const normalizedStatus = statusText.toLowerCase();
    
                                const statusClass =
                                    normalizedStatus === "approved"
                                        ? "status-active"
                                        : normalizedStatus === "rejected"
                                        ? "status-inactive"
                                        : "status-pending";
    
                                const statusIcon =
                                    normalizedStatus === "approved"
                                        ? "fas fa-circle-check"
                                        : normalizedStatus === "rejected"
                                        ? "fas fa-times-circle"
                                        : "fas fa-clock";
    
                                // Store leave data as data attributes
                                return `
                                    <tr class="leave-row" 
                                        data-index="${index}"
                                        data-leave-data='${JSON.stringify(leave).replace(/'/g, "&apos;")}'
                                        data-member-data='${JSON.stringify(member).replace(/'/g, "&apos;")}'>
                                        <td>
                                            <div class="member-cell">
                                                <div class="table-avatar">${initials}</div>
                                                <div class="member-info">
                                                    <span class="member-name">${member.fullName}</span>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="employee-id">${leave.employeeId}</span>
                                        </td>
                                        <td>
                                            <span class="leave-type-badge ${(leave.leaveType || '').toLowerCase().replace(/\s+/g, '-')}">
                                                ${leave.leaveType || "N/A"}
                                            </span>
                                        </td>
                                        <td>
                                            <div class="leave-period">
                                                <span class="leave-date start">${leave.startDate}</span>
                                                <span class="leave-separator">to</span>
                                                <span class="leave-date end">${leave.endDate}</span>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="leave-days-count ${(leave.leaveType || '').toLowerCase() === 'annual' ? 'annual-leave' : ''}">
                                                ${leave.leaveDays ?? "-"}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="status-badge ${statusClass}">
                                                <i class="${statusIcon}"></i>
                                                ${statusText}
                                            </span>
                                        </td>
                                    </tr>
                                `;
                            }).join("")}
                        </tbody>
                    </table>
                </div>
            `;
    
            document.querySelector(".main-content").appendChild(container);
    
            // Add click event to table rows
            setTimeout(() => {
                document.querySelectorAll('.leave-row').forEach(row => {
                    row.addEventListener('click', function() {
                        const leaveData = JSON.parse(this.getAttribute('data-leave-data'));
                        const memberData = JSON.parse(this.getAttribute('data-member-data'));
                        showLeaveApprovalModal(leaveData, memberData);
                    });
                    
                    // Add hover effect
                    
                });
            }, 100);
        }
    
        // Initial render
        filterAndRenderTable();
    
        // Add event listeners for filter controls
        document.getElementById('staffFilter').addEventListener('change', function() {
            currentStaffFilter = this.value;
            filterAndRenderTable();
        });
    
        document.getElementById('statusFilter').addEventListener('change', function() {
            currentStatusFilter = this.value;
            filterAndRenderTable();
        });
    
        document.getElementById('clearFilters').addEventListener('click', function() {
            document.getElementById('staffFilter').value = 'all';
            document.getElementById('statusFilter').value = 'all';
            currentStaffFilter = 'all';
            currentStatusFilter = 'all';
            filterAndRenderTable();
        });
    }
    
    // Original showLeaveApprovalModal function (unchanged)
    function showLeaveApprovalModal(leave, member) {
        // Remove existing modal if any
        const existingModal = document.getElementById('leaveApprovalModal');
        if (existingModal) {
            existingModal.remove();
        }
    
        // Create modal
        const modal = document.createElement('div');
        modal.id = 'leaveApprovalModal';
        modal.className = 'modal-overlay';
        
        // Helper to render approval status
        const renderApprovalStatus = (approved, type) => {
            if (approved) {
                return `
                    <div class="approval-status approved">
                        <i class="fas fa-check-circle"></i>
                        <span>${type} Approved</span>
                    </div>
                `;
            } else {
                return `
                    <div class="approval-status pending">
                        <i class="fas fa-clock"></i>
                        <span>${type} Pending</span>
                    </div>
                `;
            }
        };
    
        // Check if HOD approval is already done
        const hodApproved = leave.hodApproval === true;
        const canApproveHOD = !hodApproved;
    
        modal.innerHTML = `
            <div class="modal-content">
                <div class="modal-header">
                    <h3>Leave Approval Details</h3>
                    <button class="modal-close-btn">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div class="modal-body">
                    <!-- Staff Information -->
                    <div class="modal-section">
                        <h4>Staff Information</h4>
                        <div class="staff-info">
                            <div class="staff-avatar">${getInitials(member.fullName)}</div>
                            <div class="staff-details">
                                <h5>${member.fullName}</h5>
                                <p>${member.jobTitle || 'Employee'}</p>
                                <p class="employee-id-modal">${leave.employeeId}</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Leave Details -->
                    <div class="modal-section">
                        <h4>Leave Details</h4>
                        <div class="leave-details-grid">
                            <div class="detail-item">
                                <strong>Leave Type</strong>
                                <span>${leave.leaveType || 'N/A'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Period</strong>
                                <span>${leave.startDate} to ${leave.endDate}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Days</strong>
                                <span>${leave.leaveDays || leave.daysRequested || '-'}</span>
                            </div>
                            <div class="detail-item">
                                <strong>Status</strong>
                                <span class="status-badge ${leave.status === 'Approved' ? 'status-active' : leave.status === 'Rejected' ? 'status-inactive' : 'status-pending'}">
                                    ${leave.status || 'Pending'}
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Approval Status -->
                    <div class="modal-section">
                        <h4>Approval Status</h4>
                        <div class="approval-status-grid">
                            ${renderApprovalStatus(leave.hodApproval, 'HOD')}
                            ${renderApprovalStatus(leave.hrApproval, 'HR')}
                            ${renderApprovalStatus(leave.ceoApproval, 'CEO')}
                        </div>
                    </div>
                    
                    <!-- HOD Approval Action (only if not already approved) -->
                    ${canApproveHOD ? `
                    <div class="modal-section">
                        <h4>HOD Action</h4>
                        <div class="hod-approval-section">
                            <p class="approval-note">Review and approve this leave request.</p>
                            <div class="approval-actions">
                                <button class="approve-btn hod-approve" data-leave-id="${leave.id || leave.employeeId}">
                                    <i class="fas fa-thumbs-up"></i>
                                    Approve Leave
                                </button>
                                <button class="reject-btn hod-reject" data-leave-id="${leave.id || leave.employeeId}">
                                    <i class="fas fa-thumbs-down"></i>
                                    Reject Leave
                                </button>
                            </div>
                        </div>
                    </div>
                    ` : `
                    <div class="modal-section">
                        <div class="already-approved">
                            <i class="fas fa-check-circle"></i>
                            <p>HOD approval has already been granted for this leave request.</p>
                        </div>
                    </div>
                    `}
                </div>
            </div>
        `;
    
        document.body.appendChild(modal);
    
        // Add event listeners
        modal.querySelector('.modal-close-btn').addEventListener('click', () => {
            modal.remove();
        });
    
        // Close modal when clicking outside
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.remove();
            }
        });
    
        // Add HOD approval button listener
        if (canApproveHOD) {
            modal.querySelector('.hod-approve').addEventListener('click', function() {
                const leaveId = this.getAttribute('data-leave-id');
                approveHODLeave(leaveId, true); // true = approve
            });
    
            modal.querySelector('.hod-reject').addEventListener('click', function() {
                const leaveId = this.getAttribute('data-leave-id');
                approveHODLeave(leaveId, false); // false = reject
            });
        }
    }
    
    // Original approveHODLeave function (unchanged)
    async function approveHODLeave(leaveId, approve) {
        try {
            // Show loading state
            const modal = document.getElementById('leaveApprovalModal');
            const actionSection = modal.querySelector('.hod-approval-section');
            const originalHTML = actionSection.innerHTML;
            
            actionSection.innerHTML = `
                <div class="loading-approval">
                    <div class="spinner-small"></div>
                    <p>${approve ? 'Approving' : 'Rejecting'} leave request...</p>
                </div>
            `;
    
            // Call backend API (to be implemented)
            const response = await fetch(`${API_BASE}/approve-leave`, {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    leaveId: leaveId,
                    action: approve ? 'approve' : 'reject',
                    approvalType: 'hod'
                })
            });
    
            const data = await response.json();
    
            if (data.success) {
                // Show success message
                actionSection.innerHTML = `
                    <div class="approval-success">
                        <i class="fas fa-check-circle"></i>
                        <p>Leave ${approve ? 'approved' : 'rejected'} successfully!</p>
                        <button class="modal-close-btn secondary" onclick="closeModalAndRefresh()">
                            Close & Refresh
                        </button>
                    </div>
                `;
            } else {
                // Show error message
                actionSection.innerHTML = `
                    <div class="approval-error">
                        <i class="fas fa-exclamation-circle"></i>
                        <p>Failed to process approval: ${data.message || 'Unknown error'}</p>
                        <button class="modal-close-btn secondary" onclick="location.reload()">
                            Retry
                        </button>
                    </div>
                `;
            }
    
        } catch (error) {
            console.error('Approval error:', error);
            const modal = document.getElementById('leaveApprovalModal');
            const actionSection = modal.querySelector('.hod-approval-section');
            
            actionSection.innerHTML = `
                <div class="approval-error">
                    <i class="fas fa-exclamation-circle"></i>
                    <p>Network error: ${error.message}</p>
                    <button class="modal-close-btn secondary" onclick="location.reload()">
                        Retry
                    </button>
                </div>
            `;
        }
    }
    
    // Helper function to close modal and refresh data
    function closeModalAndRefresh() {
        const modal = document.getElementById('leaveApprovalModal');
        if (modal) modal.remove();
        
        // Refresh team data
        initializePage();
    }

    
    /* =========================================================
       INITIALIZE PAGE
    ========================================================= */
    async function initializePage() {
        loadingOverlay.classList.remove("hidden");
        
        try {
            const data = await fetchTeamData();
            
            if (data) {
                cachedTeamData = data;
                
                populateManagerProfile(data.manager);
                populateTeamMembers(data.team);
    
                // ‚úÖ Cache original Team Management view ONCE
                if (!originalTeamViewHTML) {
                    originalTeamViewHTML = document.querySelector(".main-content").innerHTML;
                }
            }
        } catch (err) {
            console.error("Initialization error:", err);
        } finally {
            loadingOverlay.classList.add("hidden");
        }
    }


    
    /* =========================================================
       TAB NAVIGATION
    ========================================================= */
    // Helper function to switch tabs programmatically
    function switchToTab(tabName) {
        document.querySelectorAll(".nav-links a").forEach(link => {
            if (link.getAttribute("data-tab") === tabName) {
                link.click();
            }
        });
    }
    
    document.querySelectorAll(".nav-links a").forEach(link => {
        link.addEventListener("click", e => {
            e.preventDefault();
            const tab = link.getAttribute("data-tab");
            
            // Update active state
            document.querySelectorAll(".nav-links a").forEach(l => 
                l.classList.remove("active")
            );
            link.classList.add("active");
            
            // Handle tab switching
            switch(tab) {
                case 'team':
                    if (!originalTeamViewHTML || !cachedTeamData) return;
                
                    // Restore original Team Management UI
                    document.querySelector(".main-content").innerHTML = originalTeamViewHTML;
                
                    // Re-bind DOM references (important)
                    rebindTeamDom();
                
                    // Re-populate dynamic data
                    populateManagerProfile(cachedTeamData.manager);
                    populateTeamMembers(cachedTeamData.team);
                    break;

                case 'leaves':
                    if (!cachedTeamData) {
                        showError("Team data not loaded yet.");
                        return;
                    }
                    document.querySelector(".main-content").innerHTML = "";
                
                    renderTeamLeaves(
                        cachedTeamData.team,
                        cachedTeamData.leaves || []
                    );
                    break;

                case 'all-staff-leaves':
                    if (!cachedTeamData) {
                        showError("Team data not loaded yet.");
                        return;
                    }
                    
                    renderAllStaffLeaves(cachedTeamData.leaves || []);
                    break;

                case 'reports':
                    alert("Reports feature coming soon!");
                    break;
                case 'approvals':
                    alert("Approvals feature coming soon!");
                    break;
                case 'settings':
                    alert("Settings feature coming soon!");
                    break;
            }
        });
    });
    
    function rebindTeamDom() {
        // Header
        pageTitle = document.getElementById("pageTitle");
        pageSubtitle = document.getElementById("pageSubtitle");
        teamCount = document.getElementById("teamCount");
    
        // Manager
        managerAvatar = document.getElementById("managerAvatar");
        managerName = document.getElementById("managerName");
        managerTitle = document.getElementById("managerTitle");
        managerDepartment = document.getElementById("managerDepartment");
        managerJobCategory = document.getElementById("managerJobCategory");
        managerEmployeeId = document.getElementById("managerEmployeeId");
    
        // Team table
        teamTableContainer = document.getElementById("teamTableContainer");
        teamTableBody = document.getElementById("teamTableBody");
        emptyState = document.getElementById("emptyState");
    }

    
    /* =========================================================
       PAGE LOAD
    ========================================================= */
    document.addEventListener("DOMContentLoaded", initializePage);
    const logoutBtn = document.getElementById("logoutBtn");

    if (logoutBtn) {
        logoutBtn.addEventListener("click", async () => {
            const originalHTML = logoutBtn.innerHTML;
    
            logoutBtn.disabled = true;
            logoutBtn.innerHTML =
                `<i class="fas fa-spinner fa-spin"></i> Logging out...`;
    
            try {
                const res = await fetch(`${API_BASE}/logout`, {
                    method: "POST",
                    credentials: "include",
                    headers: { "Content-Type": "application/json" }
                });
    
                if (!res.ok) {
                    throw new Error("Logout failed");
                }
    
                // Redirect to login page
                window.location.href = "index.html";
            } catch (err) {
                console.error(err);
                showError("Unable to logout. Please try again.");
    
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = originalHTML;
            }
        });
    }

    
    // Refresh data every 30 seconds (optional)
    // setInterval(initializePage, 30000);
    </script>
</body>
</html>
